{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/cqrs/","result":{"data":{"site":{"siteMetadata":{"title":"Kim Khanh Luu"}},"markdownRemark":{"id":"66025814-fddc-554b-8d0c-db9967c6e3ed","excerpt":"Command Query Responsibility Segregation Date Created: February 24, 2023 6:09 PM\nStatus: Done üçÄ My previous post gave a very quick introduction to event‚Ä¶","html":"<h1>Command Query Responsibility Segregation</h1>\n<p>Date Created: February 24, 2023 6:09 PM\nStatus: Done üçÄ</p>\n<p>My <a href=\"https://kkhanhluu.github.io/event-sourcing-vs-event-driven-architecture/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">previous post</a> gave a very quick introduction to event sourcing, an alternative pattern to store data as events. In this post, we are going to explore on handy trick of trade that seems to be a perfect match with event sourcing: <strong>Command Query Responsibility Segregation - CQRS</strong></p>\n<h1>Context and problem</h1>\n<p>In traditional architectures, the same data model is used to query and update a database, which is simple and works perfectly well for basic CRUD operations. However, in some complex applications, this approach doesn‚Äôt work well anymore. For example, in a blog platform like medium, although the data can be stored in a SQL or NoSQL database, you could want to leverage powerful search engine like Elasticsearch to perform full-text search, which requires a completely different model. Another example is an <em>event sourcing</em> system like in an e-commerce application, where event store is the single source of truth. The data is written as events to event store, however, it‚Äôs not easy to perform complicate queries such as: find the first 100 orders from February 2023 to April 2023, against this event store. In this case, we might want to maintain a view in SQL databases so that we can perform those queries more easily. In both cases, we have the two following pain points:</p>\n<ul>\n<li>There‚Äôs if often a mismatch between read and write representations (records in normal database vs records in elasticsearch, events in event store vs order entity in SQL database)</li>\n<li>All the data replicas need to be synchronized (elasticsearch vs database, eventstore vs sql database)</li>\n</ul>\n<h1>Using CQRS pattern</h1>\n<p>CQRS separates reads and writes into different models using <strong>commands</strong> and <strong>queries</strong></p>\n<ul>\n<li><strong>Commands:</strong> are responsible for changing application state, i.e., creating, updating and deleting data. <strong>Commands</strong> should be task-based, rather than data centric (‚ÄùCreate order‚Äù, ‚ÄúCheckout order‚Äù)</li>\n<li><strong>Queries:</strong> are responsible for reading application state. <strong>Queries</strong> never modify the database</li>\n</ul>\n<p>For greater isolation, we can separate physically the read data from the write data. In the previous example of blog platform: database is the write database and Elasticsearch is the read database, that is optimized for queries. In the example of e-commerce application: eventstore is the write database and SQL database is the read database.</p>\n<p>If read and write databases are separated, we have to ensure that they must be kept in sync. This is typically accomplished by having the write model publish an event whenever it updates the database. If you want to see a real-world example, please check out my <a href=\"https://kkhanhluu.github.io/e-shop/explore/code/simplified-cqrs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">e-shop project</a>. In this demo, <code class=\"language-text\">subscription</code> feature of <a href=\"https://www.eventstore.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">EventStoreDB</a> was used to publish an event to PostgresSQL read database.</p>\n<h2>Using aggregate pattern with CQRS</h2>\n<p>The write model of CQRS pattern not only contains the data but also methods to change the data and validate it. The logic within write model should be as close as possible to business process, whe should be able to read the code and fully understand business requirements from the code. An useful pattern should be considered is the <strong>aggregate.</strong> An¬†<strong>aggregate</strong> is a cluster of associated objects that we treat as a unit for the purpose of data changes. In the e-commerce example, <code class=\"language-text\">Order</code> should be an <strong>aggregate.</strong> An order is a domain object that consists of several objects: the status, the list of items that the user already purchased, and the user who purchased the order. Besides the information, <code class=\"language-text\">Order</code> should contain methods, which take the current state, verifies rules for the particular operation, applies the business logic, and returns the new state.</p>\n<p>If you want to take a look at implementation of an <strong>aggregate</strong>, feel free to check out my <a href=\"https://kkhanhluu.github.io/e-shop/explore/code/simplified-cqrs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">e-shop project</a>.</p>\n<h1>Summary</h1>\n<p>Event sourcing is quite often conflated with CQRS, however, they are two different patterns. Event sourcing is ‚Äújust‚Äù an option for storage implementation and CQRS is about separating write and read operations. They complement each other and used together are powerful, but the separation of command logic from query logic is also applicable in designs that are not using event sourcing.</p>","frontmatter":{"title":"üìö Command Query Responsibility Segregation","date":"April 09, 2023","description":"Introduction to CQRS","time":"10"}},"previous":{"fields":{"slug":"/event-sourcing-vs-event-driven-architecture/"},"frontmatter":{"title":"üì© Event sourcing vs Event Driven architecture"}},"next":{"fields":{"slug":"/saga/"},"frontmatter":{"title":"üö¶ Saga pattern"}}},"pageContext":{"id":"66025814-fddc-554b-8d0c-db9967c6e3ed","previousPostId":"d249dd6f-31c4-5ea4-a015-7423df0b2068","nextPostId":"ffb645e3-45eb-56b7-b717-50b5df6014a8"}},"staticQueryHashes":["1642819152"]}
{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/saga/","result":{"data":{"site":{"siteMetadata":{"title":"Kim Khanh Luu"}},"markdownRemark":{"id":"ffb645e3-45eb-56b7-b717-50b5df6014a8","excerpt":"Saga pattern In this blog post, we already mentioned microservices architecture as a solution for building software by spiliting the system into more smallerâ€¦","html":"<h1>Saga pattern</h1>\n<p>In this <a href=\"https://kkhanhluu.github.io/what-is-cloud-native/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">blog post</a>, we already mentioned <strong>microservices architecture</strong> as a solution for building software by spiliting the system into more smaller and loosely coupled components. One of the most challenging problems while building such highly distributed system is managing transactions across multiple services. One approach that has gained popularity in recent years is the Saga Pattern. In this blog post, we will explore what the Saga Pattern is, how it works, and its benefits and drawbacks.</p>\n<h1>Context and problem</h1>\n<p>In a traditional architectures, local ACID transactions are used to ensure data consistency. Implementing the same operation in a <strong>microservices architecture</strong> is much more complicated because the data is scattered around various services. In the example of my <a href=\"https://kkhanhluu.github.io/e-shop\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">e-shop demo</a>, the <code class=\"language-text\">createOrder</code> operation accesses data in numerous services. It reads data from <code class=\"language-text\">User Service</code> , <code class=\"language-text\">Product Service</code> and updates data in <code class=\"language-text\">Inventory Service</code>, <code class=\"language-text\">Order Service</code> and <code class=\"language-text\">Payment Service</code>. Local ACID transaction canâ€™t be used because we have multiple databases, therefore we need a mechanism to maintain data consistency across those databases. <strong>Saga pattern</strong> is one of good approaches for this problem.</p>\n<h1>Saga pattern</h1>\n<p>A saga is a sequence of transactions that update each serviceâ€™s local database and publishes a message or event to trigger the next transaction step. If a step fails, the saga executes compensating transactions that counteract the preceding transactions.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8ca571536333f51a80f0a0c16241c72c/45cee/saga.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.50632911392405%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAABGElEQVQY052QTU4CQRCFOZcHcGHceADPpBtxpTtX3kEWJsbEvxUgJGQyCswMPUzT3fxMd/0ZaCAYd36bqrzk5dWrBiJaawGANiAi/QE3EBEzE3EUAaARBzPLb/bK4QIACIEIo7I1l0pV5dQ5t09w1qpCaa299/t8Y1yRV8ZYxLW/AUgidPs4O79RlV5MJnmW5boqp7Pl2XVx/2wkuHFWjLN8PlOtz+Vpc9JJV8KBd2a4fChOmkNjLCEQCyOU2h5dfN89KeElEiOxwKrVrY6v0k6qhcI6WUTmC9tLPzrJy7AYbAuyDItBN3ntpe9ubmJDH3wyave/3pJRe3t2bBhCqOs6ShFA8L723h/+EgDr2gPsHgYA8i8Q8QdClMhWXqrfUAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled-2023-04-23-0231.png\"\n        title=\"Untitled-2023-04-23-0231.png\"\n        src=\"/static/8ca571536333f51a80f0a0c16241c72c/f058b/saga.png\"\n        srcset=\"/static/8ca571536333f51a80f0a0c16241c72c/c26ae/saga.png 158w,\n/static/8ca571536333f51a80f0a0c16241c72c/6bdcf/saga.png 315w,\n/static/8ca571536333f51a80f0a0c16241c72c/f058b/saga.png 630w,\n/static/8ca571536333f51a80f0a0c16241c72c/40601/saga.png 945w,\n/static/8ca571536333f51a80f0a0c16241c72c/78612/saga.png 1260w,\n/static/8ca571536333f51a80f0a0c16241c72c/45cee/saga.png 3630w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>There are two common was of coordination sagas: <strong>choreography</strong> and <strong>orchestration</strong></p>\n<h2>Choreography</h2>\n<p><strong>Choreography</strong> is a way to coordinate sagas where participants exchange events <strong>without</strong> a centralized point of control. Each local transaction publishes event or message that triggers local transaction in other services</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8dfe5a087bb50e20d0c1f3d6adcdf466/f6386/choreography.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.0126582278481%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAAsTAAALEwEAmpwYAAABZElEQVQoz42TzU7DMBCE8/5vxIkLEgckbg0iIKgCaePacWyvfzd2jJpAkZoGOvLBB3/a8exuEWMEAD9JSomIeUXDMEgpvffWWiFEjLEQQlhrQwiI6JxTSo3juCRTSpxz5xwippScc5zzQkrZ9z1jrOs6xphSKqW0hGOMlFJCCJ10OBzati2ccwAwl5VSWmvPsNkIAFRVpbWOMSLibL7IOc83znlZlkKIbyaP85lJQsh+v9daA4DWOoSQcy7OIqGUcs5jjD91swaglIJSy78UZ/ZSSh1jZfW0U5R59UrqzfuLAjg9uAyf3Oacn7vtzef9Xft4u3/YdG9+GC42bwkfpdHtFC231Ue304NLabwKPtk7RtjxiENe1yrMGGt2zcWe/wOHEJqmqetaKfWb/DWwMcZaO9f03gPAWv1iOYZCCMYYIYRN6vt+OXYraY+jmmSMQURjjBBiuLJVp9Wz1hpjtNZ/LOkXghSngSv0p7sAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled-2023-04-23-0303.png\"\n        title=\"Untitled-2023-04-23-0303.png\"\n        src=\"/static/8dfe5a087bb50e20d0c1f3d6adcdf466/f058b/choreography.png\"\n        srcset=\"/static/8dfe5a087bb50e20d0c1f3d6adcdf466/c26ae/choreography.png 158w,\n/static/8dfe5a087bb50e20d0c1f3d6adcdf466/6bdcf/choreography.png 315w,\n/static/8dfe5a087bb50e20d0c1f3d6adcdf466/f058b/choreography.png 630w,\n/static/8dfe5a087bb50e20d0c1f3d6adcdf466/f6386/choreography.png 686w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>Benefits</h3>\n<ul>\n<li><strong>Simplicity:</strong> Services publish events directly when they update data</li>\n<li><strong>No single point of failure:</strong> because the responsibilities are distributed across the participants.</li>\n</ul>\n<h3>Drawbacks</h3>\n<ul>\n<li><strong>More difficult to understand:</strong> In a complicated workflow, itâ€™s sometimes difficult to understand how a given saga works or add a new step to the existing saga because a centralized logic is missing.</li>\n<li><strong>Cyclic dependencies between services</strong></li>\n</ul>\n<h2>Orchestration-based saga</h2>\n<p><strong>Orchestration</strong> is a way to coordinate sagas where participants exchange events <strong>with</strong> a centralized point of control. To execute a step, the orchestrator sends a command message to a participant. After the operation is executed, the participant sends a reply message to orchestrator. The orchestrator then processes message and send message to the next participant in case of success or executes compensating transaction in case of the operation failed.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7ce9217ff68aad2e9877a836e9976941/47aef/orchestration-based_saga.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.9620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABAUlEQVQoz5VS0WrDMAz0///aSlhHGWXQFBpawpI5dWzLkmw5I3E3usFWcgi/nI6TTlYhBCLCBdNKqL7vh2EYx7HrOma+5/KU85T/EyOitdZ7Twu89ymlv7pFsqRb5ZzVzSTnL1oAABFZomWwDCyxUAGlbuLhlOomHZp0aZNiZlgQQijiGKMb7bZ+rfp91e3b8SNAAHDni652vHnhp2fabOntmJQx5nq9ltc5h4iz2Lr3vmOJlFiyFGeifJydY32a/c9tmncGgBK4yNzHzGWKx2mXbiIqaxMRANyn8CP/Jf3vUiJSco4xFv8VdwYAYwwAaK1/3fmxGBG11sYY59zaH/YJbzCEPT0JT24AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"orchestration-based saga.png\"\n        title=\"orchestration-based saga.png\"\n        src=\"/static/7ce9217ff68aad2e9877a836e9976941/f058b/orchestration-based_saga.png\"\n        srcset=\"/static/7ce9217ff68aad2e9877a836e9976941/c26ae/orchestration-based_saga.png 158w,\n/static/7ce9217ff68aad2e9877a836e9976941/6bdcf/orchestration-based_saga.png 315w,\n/static/7ce9217ff68aad2e9877a836e9976941/f058b/orchestration-based_saga.png 630w,\n/static/7ce9217ff68aad2e9877a836e9976941/40601/orchestration-based_saga.png 945w,\n/static/7ce9217ff68aad2e9877a836e9976941/47aef/orchestration-based_saga.png 1063w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>Benefits</h3>\n<ul>\n<li><strong>Simpler dependencies</strong>: The orchestrator invokes the participant but not vice versa. As a result, there are no cyclic dependencies.</li>\n<li><strong>Improve separation of concerns and simplifies the business logic:</strong> with the introduction of a centralized saga orchestrator, the services donâ€™t have to care about the saga logic anymore. They just focus on business logic and therefore we are following the letter S in SOLID principle. Itâ€™s also easier for developers to understand the whole saga flow because we just have to look at the code of one single component.</li>\n</ul>\n<h3>Drawbacks</h3>\n<ul>\n<li><strong>Additional complexity:</strong> Implementing saga orchestrator of course requires additional design complexity.</li>\n<li><strong>Single point failure:</strong> because the orchestrators manages the complete workflow</li>\n</ul>\n<h1>Summary</h1>\n<p>The Saga Pattern is a distributed transaction management pattern that provides an approach to handle long-lived transactions in a distributed environment. Simple sagas can use choreography, but orchestration is usually a better approach for complex sagas. If you want to have a real-world example of saga pattern, feel free to check out my <a href=\"https://kkhanhluu.github.io/e-shop/explore/code/saga-pattern\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">e-shop project</a>. It leverages <a href=\"https://docs.spring.io/spring-statemachine/docs/current/reference/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">spring state machine</a> to implement a orchestrator-based saga</p>","frontmatter":{"title":"ðŸš¦ Saga pattern","date":"April 16, 2023","description":"Introduction to saga pattern","time":"10"}},"previous":{"fields":{"slug":"/cqrs/"},"frontmatter":{"title":"ðŸ“š Command Query Responsibility Segregation"}},"next":{"fields":{"slug":"/transactional-outbox/"},"frontmatter":{"title":"ðŸ“¤ Transactional outbox pattern"}}},"pageContext":{"id":"ffb645e3-45eb-56b7-b717-50b5df6014a8","previousPostId":"66025814-fddc-554b-8d0c-db9967c6e3ed","nextPostId":"d1020dde-2ba8-5139-8d46-2ab890bf2a5d"}},"staticQueryHashes":["1642819152"]}